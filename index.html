if (currentToolId && confirm('Are you sure you want to delete this tool?')) {
                    debug('Deleting tool', { id: currentToolId });
                    toolsData = toolsData.filter(t => t.id !== currentToolId);
                    renderDashboard();
                    
                    if (githubSettings.token) {
                        const button = document.getElementById('deleteTool');
                        const originalText = button.textContent;
                        button.innerHTML = '<span class="loading-spinner"></span>Deleting...';
                        button.disabled = true;
                        
                        await saveConfigToGitHub();
                        
                        button.textContent = originalText;
                        button.disabled = false;
                    } else {
                        try {
                            localStorage.setItem('dashboardTools', JSON.stringify(toolsData));
                        } catch (e) {
                            debug('localStorage not available for saving after delete', e);
                        }
                    }
                    
                    document.getElementById('adminPanel').style.display = 'none';
                }
            });
            
            // Save order button
            document.getElementById('saveOrderBtn').addEventListener('click', async function() {
                debug('Saving tool order');
                const button = document.getElementById('saveOrderBtn');
                button.classList.add('saving');
                button.innerHTML = '<span class="loading-spinner"></span>Saving...';
                
                await saveConfigToGitHub();
                
                button.classList.remove('saving');
                button.innerHTML = '<span class="material-icons">save</span>Save Order';
            });
            
            // Test GitHub connection
            document.getElementById('testGithubConnection').addEventListener('click', function() {
                testGitHubConnection();
            });
            
            // Save GitHub settings
            document.getElementById('saveGithubSettings').addEventListener('click', function() {
                saveGitHubSettings();
            });
            
            // Enter key in password field
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginAdmin').click();
                }
            });
            
            // Enter key in token field
            document.getElementById('githubToken').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('saveGithubSettings').click();
                }
            });
        }

        /* Initialize everything */
        window.addEventListener('DOMContentLoaded', async function() {
            debug('DOM content loaded, initializing application');
            
            // Set default GitHub settings
            githubSettings = {
                username: 'adamismyusername',
                repo: 'sfdash',
                token: '',
                branch: 'main'
            };
            
            document.getElementById('githubUsername').value = githubSettings.username;
            document.getElementById('githubRepo').value = githubSettings.repo;
            document.getElementById('githubBranch').value = githubSettings.branch;
            
            // Try to load token from localStorage
            try {
                const token = localStorage.getItem('githubToken');
                if (token) {
                    debug('Token loaded from localStorage');
                    githubSettings.token = token;
                    document.getElementById('githubToken').value = token;
                }
            } catch (e) {
                debug('localStorage not available for token', e);
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize default tools
            initializeDefaultTools();
            
            // Try to load config from GitHub
            let config = null;
            
            if (githubSettings.token) {
                debug('Loading config using token');
                try {
                    config = await fetchConfigFromGitHub();
                } catch (e) {
                    debug('Error loading config with token', e);
                }
            }
            
            if (!config) {
                debug('Loading public config');
                try {
                    config = await loadPublicConfigFromGitHub();
                } catch (e) {
                    debug('Error loading public config', e);
                }
            }
            
            if (config && config.toolsData) {
                debug('Config loaded', { toolCount: config.toolsData.length });
                toolsData = config.toolsData;
                try {
                    localStorage.setItem('dashboardTools', JSON.stringify(toolsData));
                } catch (e) {
                    debug('Could not save loaded tools to localStorage', e);
                }
            }
            
            // Render the dashboard
            renderDashboard();
            
            debug('Initialization complete');
        });

        /* Iframe resizing support */
        function resizeForIframe() {
            if (window.self !== window.top) {
                const height = document.body.scrollHeight;
                window.parent.postMessage({ type: 'resize', height }, '*');
            }
        }

        window.addEventListener('resize', resizeForIframe);
        window.addEventListener('load', resizeForIframe);
        setInterval(resizeForIframe, 500);
    </script>
</body>
</html>
